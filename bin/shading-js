#!/usr/bin/python

import cgi
import codecs
import csv
import json
import optparse
import sys

import markdown

def main():
    parser = optparse.OptionParser()
    parser.add_option("", "--shading",
                      action="store",
                      help="the name of the file containing the shading spec")
    parser.add_option("", "--blurb",
                      action="store",
                      help="the name of the Markdown file containing the blurb (optional)")
    (options, args) = parser.parse_args()
    if args:
        parser.error("Unexpected non-option arguments")
    if not options.shading:
        parser.error("The --shading argument must be supplied")
    
    key_html = u""
    if options.blurb:
        md_file = codecs.open(options.blurb, mode="r", encoding="utf8")
        md_text = md_file.read()
        key_html += u"""<div id="legendtext">"""+ markdown.markdown(md_text) +"""</div>\n"""
    
    with open(options.shading, 'r') as shading_spec_file:
        r = csv.reader(shading_spec_file)
        header = r.next()
        value_col_name = header[0]
        if header != [value_col_name, "color", "key"]:
            raise Exception("Expected header to be %r, but found %r" % ([value_col_name, "color", "key"], header))
        
        for range_str, color, key in r:
            key_html += u"""  <div class="legendswatch" style="background: {color};"></div><div class="legendtext">{key}</div>""".format(color=color, key=cgi.escape(key.decode("utf-8")))
    
    json.dump(key_html, sys.stdout)

if __name__ == "__main__":
    main()
